@page "/"
@inject MortgageCalculator MortgageCalc
@inject MortgageGrapher MortgageGrapher
@using Microsoft.AspNetCore.Components
@using System.Globalization
@using Financr.Utils

<PageTitle>Mortgage Calc</PageTitle>

<MudCard class="ma-2">
    <MudCardContent>
        <MudGrid>
            <MudItem xs=6 sm=3>
                <MudNumericField Label="Purchase Price" Min="0" Step="1000" Format="N2" Culture="@enGb" T="decimal" @bind-Value="MortgageCalc.PurchasePrice" HelperText="@MortgageCalc.PurchasePrice.ToString()" />
            </MudItem>
            <MudItem xs=6 sm=3>
                <MudNumericField Label="Deposit" Min="0" Step="1000" Format="N2" Culture="@enGb" T="decimal" @bind-Value="MortgageCalc.Deposit" HelperText="@MortgageCalc.Deposit.ToString()" />
            </MudItem>
            <MudItem xs=6 sm=3>
                <MudNumericField Label="Rate" Min="0" Step="0.01m" Format="N2" Culture="@enGb" T="decimal" @bind-Value="MortgageCalc.InterestRate" />
            </MudItem>
            <MudItem xs=6 sm=3>
                <MudNumericField Label="Years" Min="0" Step="1" Max="50" @bind-Value="MortgageCalc.Years" />
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

<MudCard class="ma-2">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Breakdown</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudGrid>
            <MudItem xs=6 sm=3>
                <MudField Class="ma-1" Label="LBTT" Variant="Variant.Filled">£@MortgageCalc.Lbtt</MudField>
            </MudItem>
            <MudItem xs=6 sm=3>
                <MudField Class="ma-1" Label="ADS" Variant="Variant.Filled">£@MortgageCalc.Ads</MudField>
            </MudItem>
        </MudGrid>
        <MudGrid>
            <MudItem xs=6 sm=3>
                <MudField Class="ma-1" Label="Total price" Variant="Variant.Filled">£@MortgageCalc.Total</MudField>
            </MudItem>
            <MudItem xs=6 sm=3>
                <MudField Class="ma-1" Label="Mortgage required" Variant="Variant.Filled">£@(MortgageCalc.MortgageAmount)</MudField>
            </MudItem>
            <MudItem xs=6 sm=3>
                <MudField Class="ma-1" Label="Mortgage payments" Variant="Variant.Filled">£@string.Format("{0:0.00}", MortgageCalc.MonthlyPayment) p/m</MudField>
            </MudItem>
        </MudGrid>
        <MudGrid>
            <MudItem xs=12 sm=6>
                <MudField Class="ma-1" Label="Cash required (no ADS)" Variant="Variant.Filled">£@(MortgageCalc.Lbtt + MortgageCalc.Deposit) (£@MortgageCalc.Deposit + £@(MortgageCalc.Lbtt))</MudField>
            </MudItem>
            <MudItem xs=12 sm=6>
                <MudField Class="ma-1" Label="Cash required (with ADS)" Variant="Variant.Filled">£@(MortgageCalc.Lbtt + MortgageCalc.Ads + MortgageCalc.Deposit) (£@MortgageCalc.Deposit + £@(MortgageCalc.Lbtt + MortgageCalc.Ads))</MudField>
            </MudItem>
        </MudGrid>
    </MudCardContent>
</MudCard>

<MudCard class="ma-2">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Amortization</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <MudChart ChartType="ChartType.Line"
                  ChartSeries="@MortgageGrapher.Series"
                  XAxisLabels="@MortgageGrapher.XAxisLabels"
                  Width="100%"
                  Height="350px"
                  ChartOptions="@MortgageGrapher.Options"></MudChart>
    </MudCardContent>
</MudCard>

<MudTable class="ma-1" Dense="true" Striped="true" Items="@MortgageCalc.AmortizationSchedule.YearlyStatements" Hover="true" Breakpoint="Breakpoint.None" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>Year</MudTh>
        <MudTh>Start Balance</MudTh>
        <MudTh>Interest</MudTh>
        <MudTh>Principal</MudTh>
        <MudTh>Ending Balance</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Year">@context.Period</MudTd>
        <MudTd DataLabel="Start Balance">@AmortizationStatement.FormatDecimal(context.StartBalance)</MudTd>
        <MudTd DataLabel="Interest">@AmortizationStatement.FormatDecimal(context.Interest)</MudTd>
        <MudTd DataLabel="Principal">@AmortizationStatement.FormatDecimal(context.Principal)</MudTd>
        <MudTd DataLabel="Ending Balance">@AmortizationStatement.FormatDecimal(context.EndingBalance)</MudTd>
    </RowTemplate>
</MudTable>

@code {
    public CultureInfo enGb = CultureInfo.GetCultureInfo("en-GB");

    protected override Task OnInitializedAsync()
    {
        MortgageCalc.PurchasePrice = 170_000;
        MortgageCalc.Deposit = 10_000;
        MortgageCalc.InterestRate= 4.64m;
        MortgageCalc.Years = 25;
        return Task.CompletedTask;
    }
}
